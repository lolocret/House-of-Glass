<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" /> 
  <title>The House of Glass â€” Interactive Infographic</title>
  <link rel="stylesheet" href="./style.css">
  <!-- GSAP for smooth transitions -->
  <script src="https://unpkg.com/gsap@3.12.2/dist/gsap.min.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <div class="intro" id="intro">
    <div class="intro-card">
      <h1 class="title">The House of Glass</h1>
      <p class="subtitle">An interactive poetic infographic about transparency</p>
      <button id="enterBtn" class="enter">Enter the House</button>
      <p class="hint">Click to enter â€” best experienced in a modern browser</p>
    </div>
  </div>

  <audio id="ambience" class="sr-audio" src="./assets/dramatic-pad.wav" preload="auto" loop></audio>

  <div id="hud" class="hud">
    <div id="narration" class="narration" aria-hidden="true"></div>
  </div>

  <div class="info-panel" id="infoPanel" aria-live="polite">
    <p class="info-panel__badge">PiÃ¨ce</p>
    <h2 id="infoTitle">Choisis une trace</h2>
    <p id="infoIntro">Clique sur une capsule pour voir ce que lâ€™on dÃ©duit de toi.</p>
    <ul id="infoList"></ul>
    <div id="infoDynamic" class="info-dynamic" aria-live="polite"></div>
    <div class="info-panel__cta">
      <button id="primaryAction" aria-live="polite">Interagir</button>
    </div>
  </div>

  <div class="teleport" id="teleport">
    <p class="teleport__title">Aller directement</p>
    <div class="teleport__grid" id="teleportGrid"></div>
  </div>

  <div class="voice-toggle">
    <button id="voiceToggle" aria-pressed="true">ðŸ”Š Voix ON</button>
  </div>

  <div class="hud-bar" id="hudBar">
    <div class="hud-bar__controls">Glisser souris = tourner | Molette = zoom | ZQSD/FlÃ¨ches = marcher | Clic = interagir</div>
    <div class="hud-bar__actions">
      <div class="hud-bar__nav" id="navQuick"></div>
      <button class="hud-bar__btn" id="muteToggle" aria-pressed="false">ðŸ”‡ Son OFF</button>
    </div>
  </div>

  <!-- You can replace ./assets/dramatic-pad.wav with another track if desired.
    Without this file the experience falls back to a synthesized pad. -->

  <noscript>Ce dÃ©mo nÃ©cessite JavaScript et un navigateur moderne prenant en charge les modules ES6.</noscript>

  <script type="module">
    import { startExperience, speakLine } from './main.js';

    const enter = document.getElementById('enterBtn');
    const intro = document.getElementById('intro');
    const narrationEl = document.getElementById('narration');
    const audioEl = document.getElementById('ambience');

    const lines = [
      'Entrez dans la Maison de Verre.',
      'Chaque piÃ¨ce murmure ce que vos donnÃ©es rÃ©vÃ¨lent.',
      'Vos choix redessinent votre profil Ã  chaque pas.'
    ];

    function showNarration(lines, delay = 600) {
      narrationEl.setAttribute('aria-hidden', 'false');
      let i = 0;
      function next() {
        if (i >= lines.length) return;
        narrationEl.textContent = lines[i];
        narrationEl.classList.remove('visible');
        void narrationEl.offsetWidth;
        narrationEl.classList.add('visible');
        // also synth voice for the first line
        if (i === 0) speakLine(lines[i]);
        i++;
        setTimeout(next, 2600);
      }
      setTimeout(next, delay);
    }

    enter.addEventListener('click', async () => {
      try {
        enter.disabled = true;
        enter.textContent = 'Enteringâ€¦';
        enter.setAttribute('aria-busy', 'true');

        // try to play ambient audio (user gesture required) only if element exists
        if (audioEl && typeof audioEl.play === 'function') {
          try {
            await audioEl.play();
            audioEl.volume = 0;
            if (window.gsap) gsap.to(audioEl, { volume: 0.45, duration: 2.5 });
          } catch (errAudio) {
            console.warn('audio.play() blocked or failed:', errAudio);
          }
        }

        await startExperience({ audioEl });

        // gentle fade-out of intro
        intro.classList.add('fade-out');
        setTimeout(() => intro.style.display = 'none', 900);
      } catch (err) {
        console.error('Failed to start experience:', err);
        enter.disabled = false;
        enter.textContent = 'Enter the House';
        enter.removeAttribute('aria-busy');
        alert('Une erreur est survenue au dÃ©marrage â€” regardez la console pour les dÃ©tails.');
      }
    });
  </script>
</body>
</html>
